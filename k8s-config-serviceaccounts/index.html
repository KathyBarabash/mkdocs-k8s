<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="canonical" href="https://example.com/mkdocs-k8s/k8s-config-serviceaccounts/">
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Service Accounts - mkdocs-k8s</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700" />

  <link rel="stylesheet" href="../css/theme.css" />
  <link rel="stylesheet" href="../css/theme_extra.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
  
  <script>
    // Current page data
    var mkdocs_page_name = "Service Accounts";
    var mkdocs_page_input_path = "k8s-config-serviceaccounts.md";
    var mkdocs_page_url = "/mkdocs-k8s/k8s-config-serviceaccounts/";
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/yaml.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/go.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/bash.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> mkdocs-k8s</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                <p class="caption"><span class="caption-text">Welcome</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="..">My Kubernetes Reference</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Overview</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../k8s-core-concepts/">Core Concepts</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Configuration</span></p>
                <ul class="current">
                    <li class="toctree-l1"><a class="reference internal" href="../k8s-config-configmaps/">Config Maps</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../k8s-config-seccontexts/">K8s Security Contexts</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../k8s-config-appresources/">Application Resource Requirements</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../k8s-config-secrets/">Secrets</a>
                    </li>
                    <li class="toctree-l1 current"><a class="reference internal current" href="./">Service Accounts</a>
    <ul class="current">
    </ul>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Observability</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../k8s-observability/">K8s observability</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Networking</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../k8s-networking/">K8s networking</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../about/">About</a>
                    </li>
                </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">mkdocs-k8s</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
        
          <li>Configuration &raquo;</li>
        
      
    
    <li>Service Accounts</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/KathyBarabash/mkdocs-k8s.git/edit/master/docs/k8s-config-serviceaccounts.md"
          class="icon icon-github"> Edit on GitHub</a>
      
    </li>
  </ul>
  
    <div class="rst-breadcrumbs-buttons" role="navigation" aria-label="breadcrumb navigation">
        <a href="../k8s-observability/" class="btn btn-neutral float-right" title="K8s observability">Next <span class="icon icon-circle-arrow-right"></span></a>
        <a href="../k8s-config-secrets/" class="btn btn-neutral" title="Secrets"><span class="icon icon-circle-arrow-left"></span> Previous</a>
    </div>
  
  <hr/>
</div>

          <div role="main">
            <div class="section">
              
                <h1 id="serviceaccounts">ServiceAccounts</h1>
<p>k8s <a href="https://kubernetes.io/docs/reference/access-authn-authz/service-accounts-admin/">service account</a> provides an identity for processes that run in a Pod. This allows processes in a pod to communicate to the api-server. Each pod by default gets assigned the default service account.</p>
<p>Let’s go ahead and test this out (instructions partly from this stackoverflow <a href="https://stackoverflow.com/questions/30690186/how-do-i-access-the-kubernetes-api-from-within-a-pod-container">post</a>):</p>
<pre><code>apiVersion: v1
kind: Pod
metadata:
  name: simple-pod
spec:
  containers:
    - name: basic
      image: radial/busyboxplus:curl
      command:
        - sleep
        - &quot;3600&quot;
</code></pre>
<p>We’ll create this pod and connect to the kubernetes API:</p>
<pre><code>kubectl create -f simplepod.yaml
kubectl exec -it simple-pod sh
KUBEHOST=&quot;aksworksho-akschallenge-d19ddd-c565b193.hcp.westus2.azmk8s.io&quot; #change this to your cluster
KUBE_TOKEN=$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)
curl -sSk -H &quot;Authorization: Bearer $KUBE_TOKEN&quot; \
      https://$KUBEHOST/api/v1/namespaces/default/pods/$HOSTNAME
</code></pre>
<p>The response to my curl (as you will see as well if your cluster is RBAC enabled) is:</p>
<pre><code>{
  &quot;kind&quot;: &quot;Status&quot;,
  &quot;apiVersion&quot;: &quot;v1&quot;,
  &quot;metadata&quot;: {

  },
  &quot;status&quot;: &quot;Failure&quot;,
  &quot;message&quot;: &quot;pods \&quot;simple-pod\&quot; is forbidden: User \&quot;system:serviceaccount:default:default\&quot; cannot get resource \&quot;pods\&quot; in API group \&quot;\&quot; in the namespace \&quot;default\&quot;&quot;,
  &quot;reason&quot;: &quot;Forbidden&quot;,
  &quot;details&quot;: {
    &quot;name&quot;: &quot;simple-pod&quot;,
    &quot;kind&quot;: &quot;pods&quot;
  },
  &quot;code&quot;: 403
</code></pre>
<p>Let’s try to solve this by <a href="https://kubernetes.io/docs/reference/access-authn-authz/rbac/">giving our default service account access to the API-server</a>. As I am lazy, I’ll show you something new, how you can create multiple objects from a single yaml file, by using the <code>---</code> in between the objects.</p>
<pre><code>apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  namespace: default
  name: pod-reader
rules:
- apiGroups: [&quot;&quot;] # &quot;&quot; indicates the core API group
  resources: [&quot;pods&quot;]
  verbs: [&quot;get&quot;, &quot;watch&quot;, &quot;list&quot;]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: read-pods
  namespace: default
subjects:
- kind: ServiceAccount
  name: default 
  apiGroup: &quot;&quot;
roleRef:
  kind: Role 
  name: pod-reader  
  apiGroup: &quot;&quot;
</code></pre>
<p>What we’ve done here, is create a Role called pod-reader, that allows its subjects to get, watch and list pods in the default namespace. Next we create a RoleBinding, that links out default ServiceAccount to that role.
Let’s create this, and see what is looks like in our pod. Btw. Notice how we didn’t kill our pod, we only made api-level changes.</p>
<pre><code>kubectl create -f solution.yaml
kubectl exec -it simple-pod sh
KUBEHOST=&quot;aksworksho-akschallenge-d19ddd-c565b193.hcp.westus2.azmk8s.io&quot; #change this to your cluster
KUBE_TOKEN=$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)
curl -sSk -H &quot;Authorization: Bearer $KUBE_TOKEN&quot; \
      https://$KUBEHOST/api/v1/namespaces/default/pods/$HOSTNAME
</code></pre>
<p>And our response is the full json definition of our pod. #SUCCESS</p>
<p>We can also create our own service accounts, and then give them permissions to pods. Let’s try the same, with a new service account, the same role, a new rolebinding and a new pod.</p>
<pre><code>apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: thanos-read-pods
  namespace: default
subjects:
- kind: ServiceAccount
  name: thanos 
  apiGroup: &quot;&quot;
roleRef:
  kind: Role 
  name: pod-reader  
  apiGroup: &quot;&quot;
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: thanos
  namespace: default
---
apiVersion: v1
kind: Pod
metadata:
  name: thanos-pod
spec:
  serviceAccountName: thanos
  containers:
    - name: basic
      image: radial/busyboxplus:curl
      command:
        - sleep
        - &quot;3600&quot;
</code></pre>
<p>Then, we’ll exec into our new pod, and try our curl again:</p>
<pre><code>kubectl exec -it thanos-pod sh
KUBEHOST=&quot;aksworksho-akschallenge-d19ddd-c565b193.hcp.westus2.azmk8s.io&quot; #change this to your cluster
KUBE_TOKEN=$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)
curl -sSk -H &quot;Authorization: Bearer $KUBE_TOKEN&quot; \
      https://$KUBEHOST/api/v1/namespaces/default/pods/$HOSTNAME

And again we get a full JSON definition of our pod. #SUCCESS
</code></pre>
<hr />
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../k8s-observability/" class="btn btn-neutral float-right" title="K8s observability">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../k8s-config-secrets/" class="btn btn-neutral" title="Secrets"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/KathyBarabash/mkdocs-k8s.git/" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
      <span><a href="../k8s-config-secrets/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../k8s-observability/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme_extra.js" defer></script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
